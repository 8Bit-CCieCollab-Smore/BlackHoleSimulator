<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Black Hole Playground ‚Äî Core+Visuals</title>
<style>
  :root{ --panel:#0d1022cc; --text:#eef2ff; --muted:#aab2d6; }
  html,body{margin:0;height:100%;background:#0b0c13;color:var(--text);font:14px/1.2 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden}
  canvas{position:absolute;inset:0;width:100%;height:100%;display:block}
  #ui{position:absolute;top:12px;left:12px;width:360px;max-height:88vh;overflow:auto;
      background:var(--panel);backdrop-filter:blur(6px);border:1px solid #1b2140;border-radius:16px;
      box-shadow:0 10px 30px #0008;padding:12px}
  #ui h1{font-size:16px;margin:0 0 8px}
  #ui .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
  #ui .row{display:flex;gap:8px;align-items:center;margin:6px 0}
  button{background:#1a1f39;color:var(--text);border:1px solid #2a3260;border-radius:10px;padding:8px 10px;cursor:pointer}
  button:hover{border-color:#3b4890}
  label{color:var(--muted)} small{color:var(--muted)} #fps{color:var(--muted)}
  .nameTag{position:absolute;pointer-events:none;color:#eef2ff;text-shadow:0 0 6px #000,0 0 12px #000;font-weight:700}
</style>
</head>
<body>
<canvas id="c"></canvas>

<div id="ui">
  <h1>üåÄ Black Hole Playground ‚Äî Core + Visuals</h1>

  <div class="grid">
    <button id="addBH">+ Black Hole</button>
    <button id="addStar">+ Star</button>
    <button id="addPlanet">+ Planet</button>
    <button id="clear">üßπ Clear</button>
    <button id="pause">‚è∏Ô∏è Pause</button>
    <button id="step">‚û°Ô∏è Step</button>
  </div>

  <div class="row"><label>Gravity G: <b id="gVal"></b></label><input id="g" type="range" min="0.15" max="2.0" step="0.001"></div>
  <div class="row"><label>Time Scale: <b id="tsVal"></b></label><input id="ts" type="range" min="0.2" max="2.5" step="0.01"></div>
  <div class="row"><label>BH Gravity Multiplier: <b id="bhgVal"></b></label><input id="bhg" type="range" min="1" max="30" step="1"></div>
  <div class="row"><label>Labels</label><input id="labels" type="checkbox" checked></div>
  <div class="row"><label>Max Bodies: <b id="mbVal"></b></label><input id="maxb" type="range" min="10" max="300" step="10"></div>

  <div class="row"><small>
    Controls: Left-drag empty = pan ‚Ä¢ Wheel = zoom (cursor-centered) ‚Ä¢ Shift+drag = move a body ‚Ä¢
    Wheel on body = change mass ‚Ä¢ <b>Right-click a body = delete</b>
  </small></div>
  <div class="row"><span id="fps">FPS</span></div>
</div>

<script>
/* ============================================================
 * CHUNK 1 ‚Äî Core + Visuals
 * ============================================================ */

const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d',{alpha:false});
const DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1));
let W=0,H=0;

function resize(){
  W=window.innerWidth; H=window.innerHeight;
  canvas.width=W*DPR; canvas.height=H*DPR;
  canvas.style.width=W+'px'; canvas.style.height=H+'px';
  ctx.setTransform(DPR,0,0,DPR,0,0);
  buildBackgroundCache();
}
window.addEventListener('resize',resize);

const cam={x:0,y:0,z:1.0};
const toScreen=(wx,wy)=>[(wx-cam.x)*cam.z+W/2,(wy-cam.y)*cam.z+H/2];
const toWorld=(sx,sy)=>[(sx-W/2)/cam.z+cam.x,(sy-H/2)/cam.z+cam.y];

// Zoom
canvas.addEventListener('wheel',e=>{
  const zoomFactor=Math.exp(-e.deltaY*0.0015);
  const [wx,wy]=toWorld(e.clientX,e.clientY);
  cam.z=Math.max(0.2,Math.min(4.0,cam.z*zoomFactor));
  const [wx2,wy2]=toWorld(e.clientX,e.clientY);
  cam.x+=(wx-wx2); cam.y+=(wy-wy2);
  e.preventDefault();
},{passive:false});

// Pan
let panning=false,panStart=[0,0],camStart=[0,0];
canvas.addEventListener('pointerdown',e=>{
  if(e.buttons===1 && !e.shiftKey){
    panning=true;panStart=[e.clientX,e.clientY];camStart=[cam.x,cam.y];
    canvas.setPointerCapture(e.pointerId);
  }
});
canvas.addEventListener('pointermove',e=>{
  if(panning){
    const dx=(e.clientX-panStart[0])/cam.z;
    const dy=(e.clientY-panStart[1])/cam.z;
    cam.x=camStart[0]-dx; cam.y=camStart[1]-dy;
  }
});
canvas.addEventListener('pointerup',()=>{panning=false;});

// Background
const bgCanvas=document.createElement('canvas');
const bgctx=bgCanvas.getContext('2d');
let BG_W=3072,BG_H=3072;

function buildBackgroundCache(){
  BG_W=BG_H=3072;
  bgCanvas.width=BG_W; bgCanvas.height=BG_H;

  const g=bgctx.createRadialGradient(BG_W*0.6,BG_H*0.35,40,BG_W*0.5,BG_H*0.5,Math.hypot(BG_W,BG_H)*0.9);
  g.addColorStop(0.0,'#3f3a6b');
  g.addColorStop(0.35,'#2b2f56');
  g.addColorStop(0.72,'#171a2a');
  g.addColorStop(1.0,'#0b0c13');
  bgctx.fillStyle=g; bgctx.fillRect(0,0,BG_W,BG_H);

  // Nebula fog
  bgctx.globalAlpha=0.06;
  for(let i=0;i<8;i++){
    const x=Math.random()*BG_W,y=Math.random()*BG_H;
    const r=Math.random()*BG_W*0.3+BG_W*0.15;
    const fog=bgctx.createRadialGradient(x,y,r*0.2,x,y,r);
    fog.addColorStop(0,'rgba(180,120,255,0.8)');
    fog.addColorStop(1,'rgba(0,0,0,0)');
    bgctx.fillStyle=fog; bgctx.beginPath(); bgctx.arc(x,y,r,0,Math.PI*2); bgctx.fill();
  }
  bgctx.globalAlpha=1;

  // Stars
  for(let i=0;i<1800;i++){
    const x=Math.random()*BG_W,y=Math.random()*BG_H;
    const r=Math.random()*1.4;
    const a=0.18+Math.random()*0.65;
    bgctx.globalAlpha=a;
    bgctx.fillStyle=(Math.random()<0.7)?'#e8edff':'#ffd9b0';
    bgctx.beginPath(); bgctx.arc(x,y,r,0,Math.PI*2); bgctx.fill();
  }
  bgctx.globalAlpha=1;
}

function drawBackground(){
  const vw=W/cam.z,vh=H/cam.z;
  const sx=cam.x-vw/2,sy=cam.y-vh/2;
  const x0=Math.floor(sx/BG_W)*BG_W,y0=Math.floor(sy/BG_H)*BG_H;
  for(let y=y0;y<sy+vh;y+=BG_H){
    for(let x=x0;x<sx+vw;x+=BG_W){
      const [sx0,sy0]=toScreen(x,y);
      ctx.drawImage(bgCanvas,sx0,sy0,BG_W*cam.z,BG_H*cam.z);
    }
  }
}

// Names + colors
const NAME={
  stars:["Sun","Sirius","Proxima","Betelgeuse","Rigel","Vega","Altair","Deneb","Arcturus","Polaris"],
  planets:["Mercury","Venus","Earth","Mars","Jupiter","Saturn","Uranus","Neptune"],
  blackholes:["Sagittarius A*","M87*","Cygnus X-1","TON 618"]
};
const TYPE={BH:'bh',STAR:'star',PLANET:'planet'};
const rand=(a=0,b=1)=>a+Math.random()*(b-a);
const TAU=Math.PI*2;

const STAR_CLASSES=[{color:'#ffcc6f',weight:0.7},{color:'#ffd2a1',weight:0.3},{color:'#a6c8ff',weight:0.2},{color:'#ff8c6f',weight:0.1},{color:'#c2e0ff',weight:0.05}];
function pickStarColor(){
  let sum=STAR_CLASSES.reduce((s,c)=>s+c.weight,0),r=Math.random(),acc=0;
  for(const c of STAR_CLASSES){acc+=c.weight/sum;if(r<acc)return c.color;}
  return '#fff';
}
const planetPalette=['#8fd3ff','#9ae6b4','#eab1ff','#ffd6a5','#c0b6ff','#a1f0ff','#ffadbc','#9cffd1'];

function randomName(type){
  if(type===TYPE.BH) return NAME.blackholes[(Math.random()*NAME.blackholes.length)|0];
  if(type===TYPE.STAR) return NAME.stars[(Math.random()*NAME.stars.length)|0];
  return NAME.planets[(Math.random()*NAME.planets.length)|0];
}
  /* ============================================================
 * CHUNK 2 ‚Äî Physics Upgrades
 * ============================================================ */

const params={
  G:0.6,
  dtScale:1.0,
  BH_G_MULT:10,
  maxBodies:150,
  drawLabels:true,
  paused:false
};

const bodies=[];
const trails=[];

// Radius from mass
function radiusFromMass(m,type){
  if(type===TYPE.BH) return Math.max(3,Math.pow(m,0.22));
  if(type===TYPE.STAR) return Math.max(2,Math.pow(m,0.35));
  return Math.max(2,Math.pow(m,0.33));
}

// Make body
function makeBody(type,opts={}){
  const b={
    id:Math.random().toString(36).slice(2),
    type,
    x:opts.x??cam.x+rand(-200,200)/cam.z,
    y:opts.y??cam.y+rand(-200,200)/cam.z,
    vx:opts.vx??rand(-20,20),
    vy:opts.vy??rand(-20,20),
    m:opts.m??(
      type===TYPE.BH?rand(4e4,12e4):
      type===TYPE.STAR?rand(3e3,1.5e4):
      rand(80,800)
    ),
    r:0,
    name:opts.name??randomName(type),
    color:opts.color??(
      type===TYPE.STAR?pickStarColor():
      planetPalette[(Math.random()*planetPalette.length)|0]
    ),
    acc:{x:0,y:0},
    locked:false,
    fading:false,
    fadeT:0,
    disk:0 // accretion disk intensity
  };
  b.r=radiusFromMass(b.m,type);
  bodies.push(b);
  trails.push([]);
  return b;
}

// Gravity + physics
function gravityStep(dt){
  for(const b of bodies){b.acc.x=0;b.acc.y=0;}
  const toRemove=new Set();

  for(let i=0;i<bodies.length;i++){
    const bi=bodies[i];
    for(let j=i+1;j<bodies.length;j++){
      const bj=bodies[j];
      if(!bi||!bj) continue;

      const dx=bj.x-bi.x,dy=bj.y-bi.y;
      const d2=dx*dx+dy*dy+25,d=Math.sqrt(d2);

      // Gravity
      let G=params.G;
      if(bi.type===TYPE.BH||bj.type===TYPE.BH) G*=params.BH_G_MULT;
      const f=G*bi.m*bj.m/d2,fx=f*dx/d,fy=f*dy/d;
      bi.acc.x+=fx/bi.m; bi.acc.y+=fy/bi.m;
      bj.acc.x-=fx/bj.m; bj.acc.y-=fy/bj.m;

      // Collision / merge
      if(d<Math.max(bi.r,bj.r)*0.85){
        const eater=(bi.type===TYPE.BH||bi.m>=bj.m)?bi:bj;
        const food=(eater===bi?bj:bi);

        eater.m+=food.m;
        eater.vx=(eater.vx*eater.m+food.vx*food.m)/(eater.m+food.m);
        eater.vy=(eater.vy*eater.m+food.vy*food.m)/(eater.m+food.m);
        eater.r=radiusFromMass(eater.m,eater.type);

        if(eater.type===TYPE.BH) eater.disk=1.0; // accretion disk flash

        toRemove.add(food.id);
      }
    }
  }

  // Move
  for(const b of bodies){
    b.vx+=b.acc.x*dt;
    b.vy+=b.acc.y*dt;
    if(!b.locked){
      b.x+=b.vx*dt; b.y+=b.vy*dt;
    }

    // Radiation pressure (stars push light bodies)
    if(b.type===TYPE.STAR){
      for(const p of bodies){
        if(p!==b && p.type===TYPE.PLANET){
          const dx=p.x-b.x,dy=p.y-b.y,dist2=dx*dx+dy*dy;
          if(dist2<=(b.r*80)**2){
            const f=50/dist2; // weak push
            p.vx+=dx*f*dt; p.vy+=dy*f*dt;
          }
        }
      }
    }

    // Collapse: very massive star ‚Üí BH
    if(b.type===TYPE.STAR && b.m>2e4){
      b.type=TYPE.BH;
      b.color='#000';
      b.r=radiusFromMass(b.m,TYPE.BH);
      b.name="Collapsed Star";
      b.disk=1.0;
    }
  }

  // Remove merged bodies
  for(let i=bodies.length-1;i>=0;i--){
    if(toRemove.has(bodies[i].id)){
      bodies.splice(i,1);
      trails.splice(i,1);
    }
  }
}

// Spaghettification check
function spaghettiFactor(bh,body){
  const dx=body.x-bh.x,dy=body.y-bh.y;
  const dist=Math.sqrt(dx*dx+dy*dy);
  if(dist<bh.r*8) return Math.min(1,(bh.r*8-dist)/(bh.r*8));
  return 0;
}

// Rendering bodies
function drawBody(b,dt){
  const [sx,sy]=toScreen(b.x,b.y);
  ctx.save(); ctx.translate(sx,sy);

  if(b.type===TYPE.BH){
    const R=b.r*cam.z;
    ctx.fillStyle='#000';
    ctx.beginPath();ctx.arc(0,0,R,0,TAU);ctx.fill();

    // Photon ring
    ctx.strokeStyle='#9be1ff';
    ctx.globalAlpha=0.7;
    ctx.lineWidth=1.5;
    ctx.beginPath();ctx.arc(0,0,R*1.05,0,TAU);ctx.stroke();

    // Shimmer rings
    for(let i=0;i<3;i++){
      const rr=R*(1.2+i*0.15);
      ctx.strokeStyle=`rgba(150,200,255,${0.12-i*0.03})`;
      ctx.beginPath();ctx.arc(0,0,rr,0,TAU);ctx.stroke();
    }

    // Accretion disk
    if(b.disk>0){
      const grad=ctx.createRadialGradient(0,0,R*0.8,0,0,R*4);
      grad.addColorStop(0,'rgba(255,180,100,0.7)');
      grad.addColorStop(1,'rgba(255,0,0,0)');
      ctx.globalAlpha=b.disk;
      ctx.fillStyle=grad;
      ctx.beginPath();ctx.arc(0,0,R*4,0,TAU);ctx.fill();
      ctx.globalAlpha=1;
      b.disk=Math.max(0,b.disk-dt*0.5);
    }

  } else if(b.type===TYPE.STAR){
    const R=b.r*cam.z;
    const grd=ctx.createRadialGradient(0,0,R*0.35,0,0,R*1.8);
    grd.addColorStop(0,'#fff6d6');
    grd.addColorStop(0.25,b.color);
    grd.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=grd;
    ctx.beginPath();ctx.arc(0,0,R*1.8,0,TAU);ctx.fill();
    ctx.fillStyle='#fff';
    ctx.beginPath();ctx.arc(0,0,R*0.8,0,TAU);ctx.fill();

  } else {
    let R=b.r*cam.z;
    R=Math.min(R,100); // cap radius so it never crashes
    ctx.fillStyle=b.color;
    ctx.beginPath();ctx.arc(0,0,R,0,TAU);ctx.fill();

    // Spaghettification
    for(const bh of bodies){
      if(bh.type===TYPE.BH){
        const f=spaghettiFactor(bh,b);
        if(f>0){
          ctx.scale(1+f*1.5,1-f*0.5);
        }
      }
    }

    ctx.globalAlpha=0.6;
    ctx.fillStyle='#fff';
    ctx.beginPath();ctx.arc(-R*0.3,-R*0.3,R*0.3,0,TAU);ctx.fill();
  }

  ctx.restore();
}

</script>
</body>
</html>
